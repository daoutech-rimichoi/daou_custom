<%# ì´ˆê¸°í™”ë©´ ì¬ì •ì˜ %>
<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'welcome_dashboard', :plugin => 'daou_custom' %>
  <%= javascript_include_tag "chart.umd.min.js", :plugin => 'daou_custom' %>
  <%= javascript_include_tag "chartjs-plugin-datalabels.min.js", :plugin => 'daou_custom' %>
<% end %>

<!-- ìƒë‹¨ í†µí•© í¬í„¸ ì„¹ì…˜ -->
<%= Setting.welcome_text.html_safe %>

<!-- í•˜ë‹¨ í”„ë¡œì íŠ¸ í˜„í™© ì°¨íŠ¸ -->
<h2 class="dashboard-main-title">ğŸ“Š í”„ë¡œì íŠ¸ë³„ ì´ìŠˆì²˜ë¦¬ í˜„í™©</h2>

<!-- ë‚ ì§œ ê²€ìƒ‰ í¼ ì¶”ê°€ -->
<div class="date-filter-container">
  <% default_start = (Date.today - 1.year).strftime('%Y-%m-%d') %>
  <% default_end = Date.today.strftime('%Y-%m-%d') %>
  <% current_start = params[:start_date].presence || default_start %>
  <% current_end = params[:end_date].presence || default_end %>

  <form class="date-filter-form" method="get">
    <div class="filter-item">
      <label for="start_date">ì‹œì‘ì¼</label>
      <input class="datepicker-input" type="date" id="start_date" name="start_date" value="<%= current_start %>" onkeydown="return false" onclick="this.showPicker()">
    </div>
    <span class="filter-separator">~</span>
    <div class="filter-item">
      <label for="end_date">ì¢…ë£Œì¼</label>
      <input class="datepicker-input" type="date" id="end_date" name="end_date" value="<%= current_end %>" onkeydown="return false" onclick="this.showPicker()">
    </div>
    <button class="filter-submit-btn" type="submit">ì¡°íšŒ</button>
    <% if params[:start_date].present? || params[:end_date].present? %>
      <a class="filter-reset-link" href="<%= request.path %>">ì´ˆê¸°í™”</a>
    <% end %>
  </form>

  <div class="filter-info">
    <span class="filter-info-icon">â„¹ï¸</span>
    ì¼ê°ì˜ <strong>ìƒì„±ì¼</strong> ê¸°ì¤€ ê²€ìƒ‰ (ìµœëŒ€ 365ì¼)
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var startDateInput = document.getElementById('start_date');
        var endDateInput = document.getElementById('end_date');

        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) {
            var year = date.getFullYear();
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var day = date.getDate().toString().padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function updateConstraints() {
            var startVal = startDateInput.value ? new Date(startDateInput.value) : null;
            var endVal = endDateInput.value ? new Date(endDateInput.value) : null;

            if (startVal) {
                // ì¢…ë£Œì¼ì˜ ìµœì†Œê°’ì€ ì‹œì‘ì¼
                endDateInput.min = formatDate(startVal);
                // ì¢…ë£Œì¼ì˜ ìµœëŒ€ê°’ì€ ì‹œì‘ì¼ + 365ì¼
                endDateInput.max = formatDate(addDays(startVal, 365));
            }

            if (endVal) {
                // ì‹œì‘ì¼ì˜ ìµœëŒ€ê°’ì€ ì¢…ë£Œì¼
                startDateInput.max = formatDate(endVal);
                // ì‹œì‘ì¼ì˜ ìµœì†Œê°’ì€ ì¢…ë£Œì¼ - 365ì¼
                startDateInput.min = formatDate(addDays(endVal, -365));
            }
        }

        startDateInput.addEventListener('change', updateConstraints);
        endDateInput.addEventListener('change', updateConstraints);

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì œì•½ì¡°ê±´ ì ìš©
        updateConstraints();
    });
</script>

<div class="dashboard-container">
  <% projects = Project.visible.sorted %>
  <% def find_status(names)
       ; IssueStatus.where(name: names).first;
     end %>
  <% status_new = find_status(['ì‹ ê·œ', 'New']) %>
  <% status_in_progress = find_status(['ì§„í–‰', 'In Progress']) %>
  <% status_closed = find_status(['ì™„ë£Œ', 'Closed']) %>
  <% status_on_hold = find_status(['ë³´ë¥˜', 'On Hold']) %>
  <% display_statuses = [status_new, status_in_progress, status_closed, status_on_hold] %>

  <% if projects.any? %>
    <% projects.each do |project| %>
      <div class="project-card">
        <div class="project-title" title="<%= project.name %>">
          <%= link_to_project project %>
        </div>

        <% scope = Issue.visible.where(project_id: project.id) %>
        <% filter_start = params[:start_date].presence || default_start %>
        <% filter_end = params[:end_date].presence || default_end %>
        <% scope = scope.where("issues.created_on >= ?", filter_start.to_date.beginning_of_day) %>
        <% scope = scope.where("issues.created_on <= ?", filter_end.to_date.end_of_day) %>
        <% issue_counts = scope.group(:status_id).count %>
        <% total_count = issue_counts.values.sum %>
        <% chart_labels = [] %>
        <% chart_data = [] %>
        <% chart_colors = [] %>
        <% status_color_map = { 'ì‹ ê·œ' => '#4A90E2', 'ì§„í–‰' => '#4CAF50', 'ì™„ë£Œ' => '#7F7F7F', 'ë³´ë¥˜' => '#FF9800' } %>

        <% IssueStatus.sorted.each_with_index do |status, index| %>
          <% count = issue_counts[status.id] || 0 %>
          <% if count > 0 %>
            <% chart_labels << "#{status.name} (#{count})" %>
            <% chart_data << count %>
            <% color = status_color_map[status.name] || "hsl(#{index * 137.5 % 360}, 70%, 60%)" %>
            <% chart_colors << color %>
          <% end %>
        <% end %>

        <div class="chart-section">
          <% if total_count > 0 %>
            <canvas id="chart-<%= project.id %>"></canvas>
          <% else %>
            <p class="no-data-msg">ë°ì´í„° ì—†ìŒ</p>
          <% end %>
        </div>

        <table class="stats-table">
          <thead>
          <tr>
            <th>í•©ê³„</th>
            <th>ì‹ ê·œ</th>
            <th>ì§„í–‰</th>
            <th>ì™„ë£Œ</th>
            <th>ë³´ë¥˜</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>
              <%= link_to total_count, project_issues_path(project, set_filter: 1), class: 'clickable-count' %>
            </td>
            <% display_statuses.each do |status| %>
              <td>
                <% if status %>
                  <% count = issue_counts[status.id] || 0 %>
                  <% if count > 0 %>
                    <%= link_to count, project_issues_path(project, set_filter: 1, status_id: status.id), class: 'clickable-count' %>
                  <% else %>
                    <span style="color: #ccc;">-</span>
                  <% end %>
                <% else %>
                  <span style="color: #eee;">-</span>
                <% end %>
              </td>
            <% end %>
          </tr>
          </tbody>
        </table>

        <% if total_count > 0 %>
          <script>
              (function () {
                  const ctx = document.getElementById('chart-<%= project.id %>').getContext('2d');
                  new Chart(ctx, {
                      type: 'pie',
                      data: {
                          labels: <%= raw chart_labels.to_json %>,
                          datasets: [{
                              data: <%= raw chart_data.to_json %>,
                              backgroundColor: <%= raw chart_colors.to_json %>,
                              borderWidth: 1
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                              legend: {
                                  position: 'right',
                                  labels: {
                                      boxWidth: 10,
                                      font: {size: 10}
                                  }
                              },
                              datalabels: {
                                  color: '#fff',
                                  font: {
                                      weight: 'bold',
                                      size: 11
                                  },
                                  formatter: (value, ctx) => {
                                      return value;
                                  }
                              }
                          }
                      },
                      plugins: [ChartDataLabels]
                  });
              })();
          </script>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p>í‘œì‹œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  <% end %>
</div>